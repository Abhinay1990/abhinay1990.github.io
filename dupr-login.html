<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DUPR Login</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
      box-sizing: border-box;
    }

    iframe {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      border: none;
      z-index: 1;
    }

    #user-review-form {
      display: none;
      position: absolute;
      z-index: 2;
      background: white;
      padding: 16px;
      width: 100vw;
      max-width: 600px;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      overflow-y: auto;
      max-height: 90vh;
    }

    #user-review-form input, #user-review-form select {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      font-size: 16px;
    }

    #submit-button {
      padding: 10px 16px;
      font-size: 16px;
      width: 100%;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }

    #profile-pic {
      display: block;
      margin: 0 auto 16px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
    }

    #error-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #c62828;
      color: #fff;
      padding: 12px;
      font-size: 15px;
      display: none;
      z-index: 10;
    }
  </style>
</head>

<body>
  <div id="error-banner"></div>

  <iframe
    id="dupr-login"
    src="https://uat.dupr.gg/login-external-app/dGVzdC1jay03OTVhOTFjZC03MzgzLTRkYjItZmVjMi0wNjc1YjFhZjYwYTg="
    allow="clipboard-write"
  ></iframe>

  <div id="user-review-form">
    <img id="profile-pic" />
    <input id="name" placeholder="Full Name" />
    <input id="email" placeholder="Email" />
    <input id="phone" placeholder="Phone" />
    <input id="birthdate" placeholder="Birthdate" />
    <input id="referral" placeholder="Referral Code" />
    <select id="gender"><option>MALE</option><option>FEMALE</option><option>OTHER</option></select>
    <input id="singles" placeholder="Singles Rating" />
    <input id="doubles" placeholder="Doubles Rating" />
    <input id="location" placeholder="Location" />
    <button id="submit-button">Confirm and Continue</button>
  </div>

  <script>
    function showError(msg) {
      console.error(msg);
      const banner = document.getElementById('error-banner');
      banner.textContent = `DUPR login failed: ${msg}`;
      banner.style.display = 'block';
    }

    let globalDuprData;

    async function handleMessage(event) {
      const user = event?.data?.result?.user;
      const token = event?.data?.result?.accessToken;
      const refresh = event?.data?.result?.refreshToken;

      if (!user || !token) return showError("Incomplete DUPR data");

      // Step 1: check if user exists
      const checkResp = await fetch('https://fxqlftzkucbdmehhqxgn.supabase.co/functions/v1/dupr-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: user.email, dupr_id: user.id, check_only: true, dupr_token: token })
      });

      const checkJson = await checkResp.json();

      if (checkJson.status === 'EXISTING_USER') {
        window.location.href = `pubapp://pubapp.com/dupr-callback?access_token=${checkJson.access_token}&refresh_token=${checkJson.refresh_token}`;
        return;
      }

      // Else new user: prefill form
      globalDuprData = {
        dupr_id: user.id,
        dupr_token: token,
        refresh_token: refresh,
        fullName: user.fullName,
        email: user.email,
        phone: user.phone,
        birthdate: user.birthdate,
        referralCode: user.referralCode,
        gender: user.gender,
        imageUrl: user.imageUrl,
        singles: user.stats?.singles ?? '',
        doubles: user.stats?.doubles ?? '',
        location: user.addresses?.[0]?.shortAddress ?? ''
      };

      document.getElementById('profile-pic').src = globalDuprData.imageUrl;
      document.getElementById('name').value = globalDuprData.fullName;
      document.getElementById('email').value = globalDuprData.email;
      document.getElementById('phone').value = globalDuprData.phone;
      document.getElementById('birthdate').value = globalDuprData.birthdate;
      document.getElementById('referral').value = globalDuprData.referralCode;
      document.getElementById('gender').value = globalDuprData.gender;
      document.getElementById('singles').value = globalDuprData.singles;
      document.getElementById('doubles').value = globalDuprData.doubles;
      document.getElementById('location').value = globalDuprData.location;

      document.getElementById('user-review-form').style.display = 'block';
    }

    window.addEventListener('message', handleMessage, false);

    document.getElementById('submit-button').addEventListener('click', async () => {
      const formPayload = {
        dupr_id: globalDuprData.dupr_id,
        dupr_token: globalDuprData.dupr_token,
        refresh_token: globalDuprData.refresh_token,
        fullName: document.getElementById('name').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        birthdate: document.getElementById('birthdate').value,
        referralCode: document.getElementById('referral').value,
        gender: document.getElementById('gender').value,
        imageUrl: globalDuprData.imageUrl,
        singles: document.getElementById('singles').value,
        doubles: document.getElementById('doubles').value,
        location: document.getElementById('location').value
      };

      const response = await fetch('https://fxqlftzkucbdmehhqxgn.supabase.co/functions/v1/dupr-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formPayload)
      });

      const data = await response.json();
      if (!response.ok) return showError(data.error || 'Something went wrong');

      window.location.href = `pubapp://pubapp.com/dupr-callback?access_token=${data.access_token}&refresh_token=${data.refresh_token}`;
    });
  </script>
</body>
</html>
