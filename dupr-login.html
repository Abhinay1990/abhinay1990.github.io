<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DUPR Login</title>
  <style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
  }

  body {
    font-family: sans-serif;
    overflow: hidden;
  }

  iframe {
    width: 100vw;
    height: 100vh;
    border: none;
  }
</style>
</head>
<body>
  <iframe
    id="dupr-login"
    src="https://uat.dupr.gg/login-external-app/dGVzdC1jay03OTVhOTFjZC03MzgzLTRkYjItZmVjMi0wNjc1YjFhZjYwYTg="
    allow="clipboard-write"
  ></iframe>

  <script>
    async function handleMessage(event) {
      try {
        const { userToken, email, duprId, id: duprUserId } = event.data;

        if (!userToken || !email || !duprId || !duprUserId) {
          throw new Error("Missing required DUPR fields");
        }

        // 1. Send to Supabase Edge Function
        const response = await fetch('https://fxqlftzkucbdmehhqxgn.supabase.co/functions/v1/dupr-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            dupr_token: userToken,
            email,
            dupr_id: duprId,
            dupr_user_id: duprUserId
          })
        });

        const { access_token, refresh_token } = await response.json();

        if (!access_token || !refresh_token) {
          throw new Error("Invalid response from backend");
        }

        // 2. Redirect to FlutterFlow app via deep link
        const redirectUri = `pubapp://pubapp.com/dupr-callback?access_token=${encodeURIComponent(access_token)}&refresh_token=${encodeURIComponent(refresh_token)}`;
        window.location.href = redirectUri;

      } catch (err) {
        console.error("Error during DUPR login flow:", err);
        alert("DUPR login failed. Please try again.");
      }
    }

    window.addEventListener("message", handleMessage, false);
  </script>
</body>
</html>
